<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
	<title></title>
	<link href="https://niedzejkob.p4.team/atom.xml" rel="self" type="application/atom+xml"/>
  <link href="https://niedzejkob.p4.team/"/>
	<generator uri="https://www.getzola.org/">Zola</generator>
	<updated>2021-06-10T00:00:00+00:00</updated>
	<id>https://niedzejkob.p4.team/atom.xml</id>
	<entry xml:lang="en">
		<title>Bootstrapping on Bare Metal: FORTH in 510 bytes</title>
		<published>2021-06-10T00:00:00+00:00</published>
		<updated>2021-06-10T00:00:00+00:00</updated>
		<link href="https://niedzejkob.p4.team/bootstrap/miniforth/" type="text/html"/>
		<id>https://niedzejkob.p4.team/bootstrap/miniforth/</id>
		<content type="html">&lt;p&gt;Software is full of circular dependencies if you look deep
enough. Compilers written in the language they compile are the most obvious
example, but not the only one. To compile a kernel, you need a running kernel.
How do you break this cycle?
Since the &lt;a href=&quot;http:&#x2F;&#x2F;bootstrappable.org&#x2F;&quot;&gt;bootstrapping problem&lt;&#x2F;a&gt; has first come to my
attention, I&#x27;ve been drawn to this unique area of software engineering. Not out
of fear that someone would try to implement a &lt;a href=&quot;http:&#x2F;&#x2F;users.ece.cmu.edu&#x2F;%7Eganger&#x2F;712.fall02&#x2F;papers&#x2F;p761-thompson.pdf&quot;&gt;trusting trust&lt;&#x2F;a&gt; attack, but
simply as an interesting challenge.&lt;&#x2F;p&gt;
&lt;span id=&quot;continue-reading&quot;&gt;&lt;&#x2F;span&gt;
&lt;p&gt;11 years ago, &lt;a href=&quot;https:&#x2F;&#x2F;www.reddit.com&#x2F;r&#x2F;programming&#x2F;comments&#x2F;9x15g&#x2F;programming_thought_experiment_stuck_in_a_room&#x2F;&quot;&gt;&lt;em&gt;vanjos72&lt;&#x2F;em&gt; described on Reddit&lt;&#x2F;a&gt; what he
calls a thought experiment: what if you were locked in a room with an IBM PC,
with no operating system on it? What would be the minimum amount of software
you&#x27;d need to start out with to bootstrap back into comfort?&lt;&#x2F;p&gt;
&lt;p&gt;As it happens, I&#x27;ve recently found myself with an abundance of free time on my
hands, so I&#x27;ve decided to make this more than a thought experiment. Alas, my
computer didn&#x27;t come equipped with front panel switches, so some software needs to
be present on the computer already...&lt;&#x2F;p&gt;
&lt;p&gt;The absolutely minimal option would be a simple program that accepts input from
the keyboard, and then jumps to it. Since the keyboard input routines in the
BIOS implement alt+numpad escape codes, you don&#x27;t even need to write any base
conversion code.&lt;sup class=&quot;footnote-reference&quot;&gt;&lt;a href=&quot;#ascii-x86&quot;&gt;1&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt; Moreover, the loop doesn&#x27;t even need an end
condition — just write to the buffer backwards until you run into the existing
code and overwrite the jump target. This approach takes a mere 14 bytes:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-lst&quot; data-lang=&quot;lst&quot;&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;6a00    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;word &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;07      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;es
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;fd      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;std
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;bf1e7c  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;+&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;16&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; Adjust to taste. Beware of fenceposting.
       &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;input_loop:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;b400    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ah&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;cd16    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;int &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x16
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;aa      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosb
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;ebf9    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jmp &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short input_loop
       buffer:
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;However, I do not find the prospect of entering code this way anywhere near
appealing. I&#x27;ve decided that, since the BIOS loads an entire sector anyway, any
bootstrap seed that fits into the bootsector is fair game.&lt;sup class=&quot;footnote-reference&quot;&gt;&lt;a href=&quot;#disagree&quot;&gt;2&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt; Obviously,
one would want to maximize the utility of the chosen program. What is the most
powerful thing we can fit in 510 bytes?&lt;&#x2F;p&gt;
&lt;p&gt;Many interesting sector-sized programs have been written by Oscar Toledo. This
includes many games, such as &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;nanochess&#x2F;cubicDoom&quot;&gt;a DooM-like raycasting game&lt;&#x2F;a&gt; or a
&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;nanochess&#x2F;Toledo-Atomchess&quot;&gt;chess AI&lt;&#x2F;a&gt;, as well as a basic &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;nanochess&#x2F;bootBASIC&quot;&gt;BASIC interpreter&lt;&#x2F;a&gt;, but
the most perhaps the most relevant one for our usecase is &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;nanochess&#x2F;bootOS&quot;&gt;bootOS&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;bootOS&lt;&#x2F;code&gt; is a monolithic operating system that fits in one boot sector. It&#x27;s
able to load, execute, and save programs. Also keeps a filesystem.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;It exposes its filesystem routines with an interrupt interface, and includes a
builtin command that allows creating a file by typing in its hexdump. Very neat,
but clearly mostly intended as a multiplexer between other sector-sized
programs. What I would seek is a solution that minimizes typing in
hand-assembled machine code. Ideally, it would be a programming language, but
one that, unlike BASIC, can be extended at runtime. If you&#x27;ve read the title of
this post, you already know what I settled on — as it turns out, it&#x27;s possible
to fit a barebones FORTH in a bootsector. You can see the code in the &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;NieDzejkob&#x2F;miniforth&quot;&gt;Miniforth
repository on GitHub&lt;&#x2F;a&gt;, but I will include most of it here.&lt;&#x2F;p&gt;
&lt;p&gt;The entire FORTH takes, at this moment, 504 bytes. As you might expect, the
development process involved being on a perpetual lookout for byte-saving
opportunities. However, when I published what I thought was quite tightly
optimized code, &lt;a href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;ilyakurdyukov&quot;&gt;Ilya Kurdyukov&lt;&#x2F;a&gt; came along and managed to find 24 bytes
to be saved! I promptly reinvested this saved space in new features.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-primer-on-forth&quot;&gt;A primer on FORTH&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;em&gt;If you&#x27;ve ever written anything in FORTH, you can safely skip this section.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;p&gt;FORTH is a stack-based language. For example, a number will push its value onto
the stack, while the &lt;code&gt;+&lt;&#x2F;code&gt; &lt;em&gt;word&lt;&#x2F;em&gt; will pop two numbers and push their sum. A
common debugging utility, but one not included in Miniforth, is the
&lt;code&gt;.s&lt;&#x2F;code&gt; word, which prints the contents of the stack.&lt;&#x2F;p&gt;
&lt;pre&gt;
&lt;b&gt;1 2 3 + .s&lt;&#x2F;b&gt; &amp;lt;2&amp;gt; 1 5  ok
&lt;&#x2F;pre&gt;
&lt;p&gt;The user can define their own words with &lt;code&gt;:&lt;&#x2F;code&gt; and &lt;code&gt;;&lt;&#x2F;code&gt;. For example:&lt;&#x2F;p&gt;
&lt;pre&gt;
&lt;b&gt;: double dup + ;&lt;&#x2F;b&gt;  ok
&lt;b&gt;3 double .&lt;&#x2F;b&gt; 6  ok
&lt;&#x2F;pre&gt;
&lt;p&gt;This defines the word &lt;code&gt;double&lt;&#x2F;code&gt;, which does the same thing as &lt;code&gt;dup +&lt;&#x2F;code&gt;. &lt;code&gt;dup&lt;&#x2F;code&gt;, by
the way, is one of FORTH&#x27;s stack manipulation words. It duplicates the top
element on the stack:&lt;&#x2F;p&gt;
&lt;pre&gt;
&lt;b&gt;42 dup .s&lt;&#x2F;b&gt; &amp;lt;2&amp;gt; 42 42  ok
&lt;&#x2F;pre&gt;
&lt;p&gt;This is basically the entire language. There are some standard facilities for
conditionals and loops, but we don&#x27;t need to concern ourselves with those for
now, as they can be built on top of Miniforth later on.&lt;&#x2F;p&gt;
&lt;p&gt;To talk about the effect a word has on the state of the stack, we use a notation
like this:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;dup ( a -- a a )
swap ( a b -- b a )
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The list before the &lt;code&gt;--&lt;&#x2F;code&gt; are the inputs, with the top of stack listed last.
After the &lt;code&gt;--&lt;&#x2F;code&gt;, we list the outputs, which start at the same stack depth.
This lets us succintly describe the common aspects of a word.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;threaded-code&quot;&gt;Threaded code&lt;&#x2F;h2&gt;
&lt;p&gt;While some FORTH systems do include full-blown, optimizing compilers similar to
those one&#x27;d see in a typical programming language, there is a much simpler
strategy. After all, everything a FORTH word can do is execute other words, so a
sequence of &lt;code&gt;call&lt;&#x2F;code&gt; instructions gets us very close:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DOUBLE:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DUP
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;PLUS
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;ret
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;However, this ties up the hardware &lt;code&gt;x86&lt;&#x2F;code&gt; stack for the return stack, making us
handroll a separate stack for the actual user-level stack (known as the
&lt;em&gt;parameter stack&lt;&#x2F;em&gt;). As accessing the parameter stack is much more common, we&#x27;d
like to use the &lt;code&gt;push&lt;&#x2F;code&gt; and &lt;code&gt;pop&lt;&#x2F;code&gt; instructions for that, and instead handroll a
mechanism similar to &lt;code&gt;call&lt;&#x2F;code&gt;. Firstly, let&#x27;s simply store a list of pointers to
words:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DOUBLE:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DUP
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;PLUS
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The way this comes to life is that each primitive word fetches the address of
the next word from memory, and jumps to it. A pointer to this sequence of
pointers is kept in &lt;code&gt;SI&lt;&#x2F;code&gt;, so that the &lt;code&gt;lodsw&lt;&#x2F;code&gt; instruction allows for easy
processing of this list:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DUP:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax

    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;lodsw
    jmp &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;PLUS:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;add &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax

    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;lodsw
    jmp &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This common code can be abstracted away into a macro, which is traditionally
called &lt;code&gt;NEXT&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;%macro &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;NEXT &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;lodsw
    jmp &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;%endmacro
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This mechanism, by the way, is known as &lt;em&gt;threaded code&lt;&#x2F;em&gt;. No relation to the concurrency
primitive.&lt;&#x2F;p&gt;
&lt;p&gt;What happens if one compiled word calls another one, though? This is where the
return stack comes in. It might feel natural to use the &lt;code&gt;BP&lt;&#x2F;code&gt; register for this
stack pointer. However, in 16-bit x86, there isn&#x27;t actually a &lt;code&gt;[bp]&lt;&#x2F;code&gt; addressing
mode. The closest you can get is &lt;code&gt;[bp+imm8]&lt;&#x2F;code&gt;, which means that accessing the
memory at &lt;code&gt;bp&lt;&#x2F;code&gt; wastes a byte to specify that you do not want an offset. This is
why I use the &lt;code&gt;di&lt;&#x2F;code&gt; register for the return stack instead. Overall, this choice
saves 4 bytes.&lt;&#x2F;p&gt;
&lt;p&gt;Anyway, here is how the return stack is used to handle compiled words calling each
other. Pushing onto the return stack is particularily nice, since it&#x27;s just the
&lt;code&gt;stosw&lt;&#x2F;code&gt; instruction.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DOUBLE:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DOCOL
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DUP
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;PLUS
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;EXIT

DOCOL:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;   ; short for &amp;quot;do colon word&amp;quot;
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xchg &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; used here as `mov ax, si`, but swaps with
                ; ax are only one byte, while `mov`s are two bytes
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosw
    pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; grab the pointer pushed by `call`
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;NEXT

EXIT:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;dec &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;dec &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, [&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;]
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;NEXT
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is pretty much the execution strategy used by Miniforth, with one simple,
but significant improvement — the value on top of the stack is stored in the
&lt;code&gt;BX&lt;&#x2F;code&gt; register. This allows skipping a &lt;code&gt;push&lt;&#x2F;code&gt; and &lt;code&gt;pop&lt;&#x2F;code&gt; in many primitives:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;PLUS:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;add &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;NEXT

DROP:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;NEXT

DUP:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;NEXT
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;One case is still unresolved, though.  What happens if a word contains a number,
such as &lt;code&gt;: DOUBLE 2 * ;&lt;&#x2F;code&gt;? This is handled by &lt;code&gt;LIT&lt;&#x2F;code&gt;, which will fetch the literal
that follows out of the pointer stream:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DOUBLE:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DOCOL
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;LIT&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;2
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;MULT
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;EXIT

LIT:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;lodsw
    xchg &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;NEXT
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h2 id=&quot;the-dictionary&quot;&gt;The Dictionary&lt;&#x2F;h2&gt;
&lt;p&gt;FORTH needs a way to locate the implementation of the words the user types in.
This is the role of the &lt;em&gt;dictionary&lt;&#x2F;em&gt;. I use a structure similar to many other
small-scale FORTHs — a singly linked list of word headers, directly prepended
before the code of each word. Out of tradition, the head of the list is kept
in a variable called &lt;code&gt;LATEST&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;niedzejkob.p4.team&#x2F;bootstrap&#x2F;miniforth&#x2F;dictionary.svg&quot; alt=&quot;&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;The most significant bits of the name length field also store some flags:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;F_IMMEDIATE &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;equ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x80
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;F_HIDDEN    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;equ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x40
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;F_LENMASK   &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;equ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x1f
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;If a word is marked as &lt;code&gt;IMMEDIATE&lt;&#x2F;code&gt;, it will be executed immediately, even if
we&#x27;re currently compiling a definition. For example, this is used to implement
&lt;code&gt;;&lt;&#x2F;code&gt;.  If a word is marked as &lt;code&gt;HIDDEN&lt;&#x2F;code&gt;, it is ignored when searching through the
dictionary. Apart from being used as a rudimentary encapsulation mechanism, this
can be used to implement the traditional FORTH semantics where a word definition
can refer to the previous word with the same name (and &lt;code&gt;RECURSE&lt;&#x2F;code&gt; is used when
you want the definition currently being compiled). However, towards the end of
development, I have removed the code that actually does this from the default
implementation of &lt;code&gt;:&lt;&#x2F;code&gt; and &lt;code&gt;;&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;compression&quot;&gt;Compression&lt;&#x2F;h2&gt;
&lt;p&gt;It is usually not worth it to use compression when both the decompressor and its
payload have to fit in merely 512 bytes. However, in a FORTH implementation, one
thing that&#x27;s repeated very often is the implementation of &lt;code&gt;NEXT&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-lst&quot; data-lang=&quot;lst&quot;&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;ad      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;lodsw
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;ffe0    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jmp &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We could try to save some bytes by replacing these with jumps to a shared copy.
However, a short jump still takes two bytes — not a significant saving. As it
turns out, a special compression scheme that can only handle this one repeating
pattern is worth it, as long as you combine it with the following observation:
&lt;code&gt;NEXT&lt;&#x2F;code&gt; is almost always followed by the dictionary entry of the next primitive,
of which the link field is predictable.&lt;&#x2F;p&gt;
&lt;p&gt;I chose to implement a compression scheme where every &lt;code&gt;0xff&lt;&#x2F;code&gt; byte is replaced
with &lt;code&gt;NEXT&lt;&#x2F;code&gt;, followed by a link field, which is computed based on the previous
occurence of an &lt;code&gt;0xff&lt;&#x2F;code&gt; byte. This strategy saved 19 bytes when I introduced
it.&lt;sup class=&quot;footnote-reference&quot;&gt;&lt;a href=&quot;#compress-savings&quot;&gt;3&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;&lt;&#x2F;p&gt;
&lt;p&gt;At first, I used a &lt;code&gt;0x90&lt;&#x2F;code&gt; byte for this — after all, it&#x27;s the opcode of &lt;code&gt;nop&lt;&#x2F;code&gt;,
which I&#x27;m definitely not going to be using. However, the byte can still occur in
the immediate bytes of an instruction. It wasn&#x27;t a problem at first, but when
the code was shifting around in memory, various addresses and offsets became
&lt;code&gt;0x90&lt;&#x2F;code&gt; often enough to be a nuisance. &lt;code&gt;0xff&lt;&#x2F;code&gt; doesn&#x27;t seem to have this problem.&lt;&#x2F;p&gt;
&lt;p&gt;To create a link, we copy the value of &lt;code&gt;LATEST&lt;&#x2F;code&gt; to the decompressor output, and
update &lt;code&gt;LATEST&lt;&#x2F;code&gt; to point to the word we&#x27;ve just written. This can be done in a
very compact sequence of instructions, but it still takes enough bytes that it
is worthy it to factor it out as a subroutine — it is also used by the
implementation of &lt;code&gt;:&lt;&#x2F;code&gt;, which creates dictionary entries at runtime.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;; Creates a dictionary linked list link at DI.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;MakeLink:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xchg &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;LATEST&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;], &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;  ; AX now points at the old entry, while
                       ; LATEST and DI point at the new one.
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosw
    ret
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The decompressor used to make use of an interesting trick, where instead of a
short forward jump, an opcode is placed so the immediate argument it requires
eats the instructions we want to jump over. That is, instead of&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jmp &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .after
.write:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosb
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.after:
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;you write&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;3c      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;db &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x3c&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; skip the stosb below by comparing its opcode with AL
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.write:
aa      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosb
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Thus, if some other code jumps to &lt;code&gt;.write&lt;&#x2F;code&gt;, the &lt;code&gt;stosb&lt;&#x2F;code&gt; executes, but this
codepath just does &lt;code&gt;cmp al, 0xaa&lt;&#x2F;code&gt;. At first, I didn&#x27;t think of the &lt;code&gt;cmp al&lt;&#x2F;code&gt;
instruction, and a &lt;code&gt;mov&lt;&#x2F;code&gt; into a throwaway register instead. This &lt;a href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;NieDzejkob&#x2F;status&#x2F;1401557309118103560&quot;&gt;backfired
spectacularily&lt;&#x2F;a&gt; because of my inability to actually pick
a register that can be safely overwritten.&lt;&#x2F;p&gt;
&lt;p&gt;Ilya Kurdyukov then demonstrated &lt;a href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;ilyakurdyukov&#x2F;status&#x2F;1401736488681979906&quot;&gt;that the same bytecount can be achieved
without this kind of &amp;quot;magic&amp;quot;&lt;&#x2F;a&gt;. An analogous modification allowed
me to remove the other occurence of this trick too. The essence is that instead
of trying to skip over the &lt;code&gt;stosb&lt;&#x2F;code&gt;, we execute it unconditionally before the
codepaths branch, and then essentially undo it with &lt;code&gt;dec di&lt;&#x2F;code&gt; if necessary:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;SPECIAL_BYTE &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;equ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0xff

    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;CompressedData
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;CompressedBegin
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;COMPRESSED_SIZE
.decompress:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;lodsb
    stosb
    cmp &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;SPECIAL_BYTE
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jnz &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .not_special
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;dec &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0xffad&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; lodsw &#x2F; jmp ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosw
    mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0xe0
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosb
    call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;MakeLink
.not_special:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;loop &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.decompress
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Actually generating the compressed stream is more involved. Because I want jumps
between the compressed and uncompressed portions to work, the assembler needs to
believe it is writing the code at the location it will actually run. I first
attempted to do this by adjusting the &lt;code&gt;org&lt;&#x2F;code&gt; after each &lt;code&gt;SPECIAL_BYTE&lt;&#x2F;code&gt;, but
unfortunately, yasm didn&#x27;t like that.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;boot.s:137: error: program origin redefined
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Clearly, a separate post-processing step is necessary. I wrote a macro to shim
the bytes the decompressor will insert:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;%macro &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;compression_sentinel &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;db &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;SPECIAL_BYTE
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dd &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0xdeadbeef
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;%endmacro
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This has the added benefit of allowing a simple automated way to verify that no
&lt;code&gt;SPECIAL_BYTE&lt;&#x2F;code&gt;s slipped in by accident.&lt;&#x2F;p&gt;
&lt;p&gt;I still had to allocate the space for the compressed data. I choose the
following layout:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Uncompressed code starts at &lt;code&gt;7C00&lt;&#x2F;code&gt; — initialization, decompression, and the outer interpreter.&lt;&#x2F;li&gt;
&lt;li&gt;Compressed data immediately follows, filling up the bootsector up to a moment
before &lt;code&gt;7E00&lt;&#x2F;code&gt;.&lt;&#x2F;li&gt;
&lt;li&gt;The decompression buffer is allocated immediately after that, which is where
&lt;code&gt;yasm&lt;&#x2F;code&gt; outputs the target contents.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;To achieve this, I needed to know exactly how much space needs to be allocated
for the compressed data. First, I calculate the exact number of bytes saved by
incrementing a counter in the &lt;code&gt;compression_sentinel&lt;&#x2F;code&gt; macro:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;%assign &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;savings &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;%macro &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;compression_sentinel &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;%assign &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;savings savings&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;+&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;4
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;db &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;SPECIAL_BYTE
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dd &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0xdeadbeef
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;%endmacro
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Then, I simply subtract this from the size of the uncompressed segment:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;CompressedData:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;times &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;COMPRESSED_SIZE &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;db &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0xcc

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;CompressedBegin:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;; ...
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;CompressedEnd:

COMPRESSED_SIZE &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;equ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;CompressedEnd &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;CompressedBegin &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;savings
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The post-processing is done by a simple Python script:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-python&quot; data-lang=&quot;python&quot;&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;SPECIAL_BYTE &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;b&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;\xff&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;SENTINEL &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;SPECIAL_BYTE &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;+ &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;b&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;\xef\xbe\xad\xde&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;with &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;open&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;raw.bin&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;rb&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;as &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;f:
    data &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;f.read()

output_offset &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;data.index(&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;b&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;\xcc&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;20&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;)
chunks &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;data[output_offset:].lstrip(&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;b&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;\xcc&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;).split(SENTINEL)

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;assert &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;SPECIAL_BYTE &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;not in &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;chunks[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;]
compressed &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;bytearray&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;(chunks[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;])

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;for &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;chunk &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;in &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;chunks[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;:]:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;assert &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;SPECIAL_BYTE &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;not in &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;chunk
    compressed.extend(SPECIAL_BYTE)
    compressed.extend(chunk)

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;# Make sure that exactly the right amount of space is allocated
# for the compressed data.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;assert &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;b&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;\xcc&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;len&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;(compressed) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;in &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;data
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;assert &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;b&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;\xcc&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;len&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;(compressed) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;+ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;not in &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;data

output &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;data[:output_offset] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;+ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;compressed

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;print&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;len&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;(output), &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;bytes used&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;)
output &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;+= &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;b&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;\x00&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;510 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;len&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;(output))
output &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;+= &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;b&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;\x55\xaa&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;with &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;open&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;boot.bin&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;wb&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;as &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;f:
    f.write(output)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The same script also generates an extended disk image, which contains some
smoke-testing code in block 1:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-python&quot; data-lang=&quot;python&quot;&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;output &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;+= &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;b&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;\x00&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;512
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;output &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;+= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;open&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;test.fth&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;rb&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;).read().replace(&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;b&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;b&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39; &amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;)
output &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;+= &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;b&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39; &amp;#39; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;2048 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;len&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;(output))

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;with &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;open&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;test.img&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;#39;wb&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;as &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;f:
    f.write(output)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;compression_sentinel&lt;&#x2F;code&gt; is most often used by the &lt;code&gt;defcode&lt;&#x2F;code&gt; macro, which creates
the dictionary entry for a primitive word. It takes a label (which can then be
used to jump to the implementation of some word), the name of the word as a string,
and optionally, some flags to be ORed into the length field:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;; defcode PLUS, &amp;quot;+&amp;quot;
; defcode SEMI, &amp;quot;;&amp;quot;, F_IMMEDIATE
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;%macro &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;2&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;3 0
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;compression_sentinel
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;%strlen &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;namelength %&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;2
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;db &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;3 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;| namelength&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;2
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;%endmacro
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is then used to define the primitives. The code essentially falls-through
into a &lt;code&gt;defcode&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode PLUS&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;+&amp;quot;
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;add &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode MINUS&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;-&amp;quot;
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;sub &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xchg &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode PEEK&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;@&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; ...
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;However, &lt;code&gt;DOCOL&lt;&#x2F;code&gt;, &lt;code&gt;EXIT&lt;&#x2F;code&gt; and &lt;code&gt;LIT&lt;&#x2F;code&gt; also use the compression mechanism for their
&lt;code&gt;NEXT&lt;&#x2F;code&gt;s. Since the link field is still written out, this essentially creates
bogus dictionary entries. Fortunately, the first opcode of &lt;code&gt;EXIT&lt;&#x2F;code&gt; and &lt;code&gt;LIT&lt;&#x2F;code&gt; has
the &lt;code&gt;F_HIDDEN&lt;&#x2F;code&gt; bit set, so this is not a problem:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;CompressedBegin:

DOCOL:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xchg &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosw
    pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; grab the pointer pushed by `call`
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;compression_sentinel

LIT:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;lodsw
    xchg &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;compression_sentinel

EXIT:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;dec &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;dec &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, [&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;]

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode PLUS&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;+&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; ...
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h2 id=&quot;variables&quot;&gt;Variables?&lt;&#x2F;h2&gt;
&lt;p&gt;Immediate load instructions tend to have shorter encodings than loads from
memory:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-lst&quot; data-lang=&quot;lst&quot;&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;be3412    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x1234
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;8b363412  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x1234&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;]
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is why Miniforth stores most of its variables in the immediate fields of
instructions. Of course, this means that the address of these variables will
change on every edit of the code, which is problematic, since we will be wanting
to access these variables in FORTH code. The typical way of exposing a variable
is to create a word that pushes its address. However, that&#x27;s way too expensive
with our constraints. What I settled on is pushing the addresses onto the stack
at startup. This can be done with only 2 bytes for each address, by simply
defining the initial contents of the stack as data:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;    org &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x7c00

    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jmp &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;:start
stack:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;HERE
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;BASE
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;STATE
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;LATEST
start:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; ...
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;sp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;stack
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Even when a variable&#x27;s address needs to be pushed onto the stack, this
self-modifying code strategy saves bytes if a variable needs to be initialized —
the best way to initialize a variable is to simply allocate it within the
bootsector and &lt;code&gt;dw&lt;&#x2F;code&gt; the initial value there, which exactly evens out the stack
data, and keeps the advantage of the shorter instruction encoding.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;initialization-code&quot;&gt;Initialization code&lt;&#x2F;h2&gt;
&lt;p&gt;The first thing done after booting is setting up the &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;X86_memory_segmentation&quot;&gt;segment registers&lt;&#x2F;a&gt; and
stack. The direction flag is also cleared, so that the string instructions work
in the right direction.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jmp &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;:start
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; ...
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;start:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cs
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cs
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cs
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ds
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;es
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ss
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;sp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;stack
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;cld
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There are a two notable things about this code. Firstly, segment registers are
set through the stack. This is a byte-saving trick I&#x27;ve picked up from
&lt;code&gt;bootBASIC&lt;&#x2F;code&gt; — it allows having to initialize a general-purpose register to zero:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-lst&quot; data-lang=&quot;lst&quot;&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;31c0    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xor &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;  ; through AX - 8 bytes
8ed8    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ds&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;8ec0    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;es&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;8ed0    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ss&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;E      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;     ; through the stack - 6 bytes
0&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;E      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cs
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;E      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cs
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;F      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ds
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;07      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;es
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;17      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ss
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Secondly, one would think that, while the stack is being repointed, a small race
condition window occurs — if an interrupt happened between &lt;code&gt;pop ss&lt;&#x2F;code&gt; and &lt;code&gt;mov sp&lt;&#x2F;code&gt;,
chaos could ensue if the previous value of SP was in an unlucky place in memory.
Of course, I could just cross my fingers and hope this doesn&#x27;t happen if the 2
bytes required to wrap this in an &lt;code&gt;cli&lt;&#x2F;code&gt;&#x2F;&lt;code&gt;sti&lt;&#x2F;code&gt; pair were too much. However, it
turns out that this trade-off is not necessary due to an obscure corner of the
x86 architecture. To quote the Volume 2B of the &lt;a href=&quot;https:&#x2F;&#x2F;software.intel.com&#x2F;content&#x2F;www&#x2F;us&#x2F;en&#x2F;develop&#x2F;articles&#x2F;intel-sdm.html&quot;&gt;x86 Software Developer&#x27;s Manual&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Loading the SS register with a POP instruction&lt;sup class=&quot;footnote-reference&quot;&gt;&lt;a href=&quot;#pop-ss&quot;&gt;4&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt; suppresses or inhibits some debug exceptions and inhibits interrupts on the following instruction boundary. (The inhibition ends after delivery of an exception or the execution of the next instruction.) This behavior allows a stack pointer to be loaded into the ESP register with the next instruction (POP ESP)&lt;sup class=&quot;footnote-reference&quot;&gt;&lt;a href=&quot;#pop-esp&quot;&gt;5&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt; before an event can be delivered.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;After the segments, stack and direction flag are set up, the decompressor is
ran. Crucially, it does not use the DL register, which contains the BIOS disk
number from which we were booted. It is then poked into the implementation of
&lt;code&gt;load&lt;&#x2F;code&gt; (which is in the compressed segment), and pushed onto the stack for later
use by user code:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DRIVE_NUMBER&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;], &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;dl
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;dx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; for FORTH code
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h2 id=&quot;the-outer-interpreter&quot;&gt;The Outer Interpreter&lt;&#x2F;h2&gt;
&lt;p&gt;At this point, we reach the &lt;em&gt;outer interpreter&lt;&#x2F;em&gt; - the part of a FORTH system
that processes user input. The name &amp;quot;&lt;em&gt;outer&lt;&#x2F;em&gt; interpreter&amp;quot; distinguishes it from
the &lt;em&gt;inner&lt;&#x2F;em&gt; interpreter, which is the component that coordinates the execution
within a defined word, and consists of &lt;code&gt;NEXT&lt;&#x2F;code&gt;, &lt;code&gt;DOCOL&lt;&#x2F;code&gt;, &lt;code&gt;EXIT&lt;&#x2F;code&gt;, and &lt;code&gt;LIT&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Normally, a FORTH would expose the building blocks of its outer interpreter as
words in the dictionary, such as&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;REFILL&lt;&#x2F;code&gt; (read a line of input from the currently executing source),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;WORD&lt;&#x2F;code&gt; (parse a word from the input stream),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;FIND&lt;&#x2F;code&gt; (look up a word in the dictionary),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;&amp;gt;NUMBER&lt;&#x2F;code&gt; (convert a string to number).&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;In Miniforth, no attention is paid to this practice at all. Dictionary headers
cost bytes, and so does communicating only through the stack. In fact, &lt;code&gt;WORD&lt;&#x2F;code&gt;
and &lt;code&gt;&amp;gt;NUMBER&lt;&#x2F;code&gt; are melded together into one routine that does the job of both —
that way, the loop can be shared, which saves bytes.&lt;&#x2F;p&gt;
&lt;p&gt;This monolithic architecture also lets us decide that &lt;code&gt;BX&lt;&#x2F;code&gt; and &lt;code&gt;DI&lt;&#x2F;code&gt; are not
reserved for the top of stack and the return stack pointer, respectively, while
the outer interpreter is executing. This significantly helps with register
starvation within these comparatively complex parts of the system. These
registers are set up just before jumping to a word, and saved after it returns.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;keyboard-input&quot;&gt;Keyboard input&lt;&#x2F;h2&gt;
&lt;p&gt;After initialization is completed, the code falls through to &lt;code&gt;ReadLine&lt;&#x2F;code&gt;, the
routine for reading in an input line from the keyboard. We will also jump back
here later, when the current line of input is exhausted. The input buffer is at
&lt;code&gt;0x500&lt;&#x2F;code&gt;, directly after the &lt;a href=&quot;https:&#x2F;&#x2F;www.matrix-bios.nl&#x2F;system&#x2F;bda.html&quot;&gt;BDA&lt;&#x2F;a&gt;. While the idiomatic string format for FORTH
uses a separate length field, this buffer is NULL-terminated, as that is easier
to handle when parsing. The pointer to the unparsed fragment of the input is
stored in &lt;code&gt;InputPtr&lt;&#x2F;code&gt;, which is the only variable which does &lt;em&gt;not&lt;&#x2F;em&gt; use the
self-modification technique, as it does not need to be explicitly initialized —
it naturally gets written to before it is read.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;InputBuf &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;equ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x500
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;InputPtr &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;equ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0xa02&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; dw

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;ReadLine:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;InputBuf
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;InputPtr&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;], &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;loop&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ah&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;int &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x16
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;cmp &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x0d
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;je &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;enter
    stosb
    cmp &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x08
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jne &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .write
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;dec &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;cmp &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;InputBuf&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; underflow check
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;je &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;loop
    dec &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.write:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;PutChar
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jmp &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;loop
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;enter&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;PutChar
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x0a
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;int &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x10
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xchg &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; write the null terminator by using the BX = 0 from PutChar
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosb
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;InterpreterLoop:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;ParseWord&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; returns length in CX. Zero implies no more input.
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;jcxz short ReadLine
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The BIOS interrupt for getting a character from the keyboard does not print the
key — we have to do that ourselves. This is done with the &amp;quot;TELETYPE OUTPUT&amp;quot;
function, which already handles special characters like backspace or newline.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;PutChar:
    xor bx, bx
    mov ah, 0x0e
    int 0x10
    ret
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This function has its deficiencies. For example, the icky CRLF line endings are
needed (CR to move the cursor to the beginning of the line, and LF to move it
to the next line). Also, the backspace character only moves the cursor back a
character, and does not erase it. To get the behavior we&#x27;ve come to expect, it
would be necessary to print &lt;code&gt;\b \b&lt;&#x2F;code&gt; (to be fair, this is also the case on modern
terminals). I chose to skip that.&lt;&#x2F;p&gt;
&lt;p&gt;Finally, &lt;a href=&quot;http:&#x2F;&#x2F;www.ctyme.com&#x2F;rbrown.htm&quot;&gt;Ralf Brown&#x27;s Interrupt List&lt;&#x2F;a&gt; mentions that some BIOSes clobber
BP when the printed character causes the screen to scroll. This does not concern
us, as we do not use this register at all.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;parsing&quot;&gt;Parsing&lt;&#x2F;h2&gt;
&lt;p&gt;After we read in a line, we need to parse it into words. This is done on demand
— each word is executed (or compiled, depending on the state), as soon as it is
parsed. Apart from the interpreter loop, &lt;code&gt;ParseWord&lt;&#x2F;code&gt; is also called by
the implementation of &lt;code&gt;:&lt;&#x2F;code&gt; (to get the name of the word being defined).&lt;&#x2F;p&gt;
&lt;p&gt;As mentioned before, this routine also computes the numeric value of the word,
with the assumption that it&#x27;s valid. There is no error checking in this regard —
if a word is not found in the dictionary, its numeric value is pushed, which is
probably nonsense if this wasn&#x27;t intended.&lt;&#x2F;p&gt;
&lt;p&gt;We start out by skipping any whitespace in the input buffer:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;; returns
; DX = pointer to string
; CX = string length
; BX = numeric value
; clobbers SI and BP
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;ParseWord:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;InputPtr&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; repe scasb would probably save some bytes here if the registers worked out - scasb
    ; uses DI instead of SI :(
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.skiploop:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;dx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; if we exit the loop in this iteration, dx will point to the first letter
               ; of the word
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;lodsb
    cmp &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot; &amp;quot;
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;je &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .skiploop
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Note the way the pointer to the beginning of the string is saved. The loop will
go one byte past the whitespace, so storing it after the loop would require a
separate decrement. Instead, we update the register with each iteration of the
loop, but before the pointer is incremented by &lt;code&gt;lodsb&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;At this point, the &lt;code&gt;AL&lt;&#x2F;code&gt; register is loaded with the first character of the word.
Thus our next loop will need to do &lt;code&gt;lodsb&lt;&#x2F;code&gt; at its &lt;em&gt;end&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xor &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xor &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.takeloop:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;and &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;~&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x20
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jz &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short Return&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; jump to a borrowed `ret` from some other routine
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This &lt;code&gt;and&lt;&#x2F;code&gt; instruction is interesting, as it does three things at once. It
detects both spaces and null bytes in one fell swoop, but also also turns off
the bit that differs between uppercase and lowercase letters, which allows
handling both cases of hexadecimal numbers at no extra cost.&lt;&#x2F;p&gt;
&lt;p&gt;If we haven&#x27;t detected the end of the word, we increment the length counter
and convert the digit to its numeric value:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;inc &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;sub &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;0&amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;&amp;amp;~&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x20
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;cmp &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;9
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jbe &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.digit_ok
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;sub &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;A&amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;0&amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;&amp;amp;~&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x20&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;10
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.digit_ok
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;cbw
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;cbw&lt;&#x2F;code&gt; is a little-known instruction that converts a signed number from &lt;code&gt;b&lt;&#x2F;code&gt;yte to
&lt;code&gt;w&lt;&#x2F;code&gt;ord, but for us it&#x27;s just a shorter &lt;code&gt;mov ah, 0&lt;&#x2F;code&gt;. In a perhaps similar vein,
we use the signed multiply &lt;code&gt;imul&lt;&#x2F;code&gt;, because it has more options for how it uses
the registers than the unsigned &lt;code&gt;mul&lt;&#x2F;code&gt;. The particular form used here allows
multiplying by an immediate and doesn&#x27;t overwrite &lt;code&gt;DX&lt;&#x2F;code&gt; with the upper half of
the product.&lt;sup class=&quot;footnote-reference&quot;&gt;&lt;a href=&quot;#imul&quot;&gt;6&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;&lt;&#x2F;p&gt;
&lt;p&gt;This particular instruction needs to be encoded manually to force the literal
width to be 2 bytes wide.&lt;sup class=&quot;footnote-reference&quot;&gt;&lt;a href=&quot;#base-dw&quot;&gt;7&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; imul bx, bx, &amp;lt;BASE&amp;gt; but yasm insists on encoding the immediate in just one byte...
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;db &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x69&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0xdb
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;BASE &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;equ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;$
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;16
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;add &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; add the new digit
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Finally, we set up for the next iteration of the loop. We use a similar trick as
before, where a pointer result is updated in each iteration to avoid a separate
decrement at the end — we need to make sure that the input pointer doesn&#x27;t point
after the terminator.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;InputPtr&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;], &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;lodsb
    jmp &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .takeloop
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h2 id=&quot;dictionary-lookup&quot;&gt;Dictionary Lookup&lt;&#x2F;h2&gt;
&lt;p&gt;After a word is parsed, we try to look it up in the dictionary. For each entry,
we need to compare the length of the name, and if it matches, the name itself.
By including &lt;code&gt;F_HIDDEN&lt;&#x2F;code&gt; in the mask, we automatically handle hidden entries,
too. The way we&#x27;re comparing the length might look a bit weird. The goal is to
keep the &lt;code&gt;F_IMMEDIATE&lt;&#x2F;code&gt; bit in AL, so that we don&#x27;t have to keep around the
pointer to the header of this word.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;InterpreterLoop:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;ParseWord
    jcxz short ReadLine

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;; Try to find the word in the dictionary.
; SI = dictionary pointer
; DX = string pointer
; CX = string length
; Take care to preserve BX, which holds the numeric value.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;LATEST &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;equ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;+&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;1
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.find:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;lodsw
    push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; save pointer to next entry
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;lodsb
    xor &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cl&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; if the length matches, then AL contains only the flags
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;test &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;F_HIDDEN | F_LENMASK
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jnz &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .next

    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;dx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;repe &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;cmpsb
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;je &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .found
.next:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;or &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jnz &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .find

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; If we reach this point, it&amp;#39;s a number.
    ; ...

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.found:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; discard pointer to next entry
    ; When we get here, SI points to the code of the word, and AL contains
    ; the F_IMMEDIATE flag
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This part shows another advantage of not splitting the interpreter into reusable
chunks — we can easily exit into two different codepaths, based on the result of
the lookup.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;should-we-execute-it&quot;&gt;Should we execute it?&lt;&#x2F;h2&gt;
&lt;p&gt;The system can be in two possible states:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;interpreting — all words should be executed&lt;&#x2F;li&gt;
&lt;li&gt;compiling — immediate words should be executed&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;In other words, a word should be executed if it is immediate, or we&#x27;re
interpreting. We store this flag in the immediate field of an &lt;code&gt;or&lt;&#x2F;code&gt; instruction —
it will be set to 0 when compiling:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; When we get here, SI points to the code of the word, and AL contains
    ; the F_IMMEDIATE flag
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;STATE &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;equ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;+&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;1
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;or &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;1
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xchg &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; both codepaths need the pointer to be in AX
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jz &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .compile

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; Execute the word
    ; ...
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The most important words that need to change the state are &lt;code&gt;:&lt;&#x2F;code&gt; and &lt;code&gt;;&lt;&#x2F;code&gt;, but they
just jump to &lt;code&gt;[&lt;&#x2F;code&gt; and &lt;code&gt;]&lt;&#x2F;code&gt; — words that allow to temporarily drop back to
interpreted mode while compiling a word. The typical usecase is to eagerly
calculate the value of a constant expression:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-forth&quot; data-lang=&quot;forth&quot;&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;: third-foo [ foos 3 cells + ] literal @ ;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Since the two values of &lt;code&gt;STATE&lt;&#x2F;code&gt; differ only by 1, we can switch between them
with &lt;code&gt;inc&lt;&#x2F;code&gt; and &lt;code&gt;dec&lt;&#x2F;code&gt;. This has the disadvantage that they are no longer
idempotent, but this shouldn&#x27;t matter to well-written code:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode LBRACK&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;[&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;F_IMMEDIATE
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;inc &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;byte&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;STATE&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;]

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode RBRACK&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;]&amp;quot;
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;dec &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;byte&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;STATE&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;]
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h2 id=&quot;executing-the-word&quot;&gt;Executing the word&lt;&#x2F;h2&gt;
&lt;p&gt;If we decided to execute the word, we retrieve &lt;code&gt;BX&lt;&#x2F;code&gt; and &lt;code&gt;DI&lt;&#x2F;code&gt;, and set up &lt;code&gt;SI&lt;&#x2F;code&gt;
so that &lt;code&gt;NEXT&lt;&#x2F;code&gt; will jump back to &lt;code&gt;.executed&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; Execute the word
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;RetSP &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;equ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;+&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;1
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;RS0
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.return
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jmp &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.return:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.executed
.executed:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;RetSP&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;], &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jmp &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short InterpreterLoop
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h2 id=&quot;handling-numbers&quot;&gt;Handling numbers&lt;&#x2F;h2&gt;
&lt;p&gt;There is no &lt;code&gt;F_IMMEDIATE&lt;&#x2F;code&gt; flag for numbers, so we just need to check the state
to decide.  It&#x27;s a simple comparison, but if we&#x27;re clever enough, you can save a
byte here. Let&#x27;s look again at the code that searches the dictionary. What value
will &lt;code&gt;AH&lt;&#x2F;code&gt; have when we reach the number case?&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.find:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;lodsw
    push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; save pointer to next entry
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;lodsb
    xor &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cl&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; if the length matches, then AL contains only the flags
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;test &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;F_HIDDEN | F_LENMASK
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jnz &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .next

    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;dx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;repe &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;cmpsb
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;je &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .found
.next:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;or &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jnz &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .find

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; AH = ?
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Do you see it? At this point, AH is zero, since it contains the higher half of the pointer
to the next word, which we know is NULL, as we just got to the end of the list.
This allows us to check the value of &lt;code&gt;STATE&lt;&#x2F;code&gt; without loading it into a register
or any immediate bytes:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; It&amp;#39;s a number. Push its value - we&amp;#39;ll pop it later if it turns out we need to compile
    ; it instead.
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;cmp &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;byte&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;STATE&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;], &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ah
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jnz &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short InterpreterLoop
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; Otherwise, compile the literal.
    ; ...
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h2 id=&quot;compiling-things&quot;&gt;Compiling things&lt;&#x2F;h2&gt;
&lt;p&gt;The output pointer for the compilation process is called &lt;code&gt;HERE&lt;&#x2F;code&gt;. It starts out
just after the decompressed data. The function that writes out a word into this
area is called &lt;code&gt;COMMA&lt;&#x2F;code&gt;, since the FORTH word that does this is &lt;code&gt;,&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;COMMA:
HERE &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;equ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;+&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;1
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;CompressedEnd&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;], &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;add &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;word&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;HERE&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;], &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;2
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;ret
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It is used in a straight-forward way to compile both numbers and words. We can
share the tail, though — compiling a word will jump into the middle of compiling
a number:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; Otherwise, compile the literal.
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;LIT
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;COMMA
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.compile:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;COMMA
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jmp &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short InterpreterLoop
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The last piece of the puzzle are &lt;code&gt;:&lt;&#x2F;code&gt; and &lt;code&gt;;&lt;&#x2F;code&gt;. Let&#x27;s look at &lt;code&gt;:&lt;&#x2F;code&gt; first. Since
&lt;code&gt;ParseWord&lt;&#x2F;code&gt; makes use of &lt;code&gt;BX&lt;&#x2F;code&gt; and &lt;code&gt;SI&lt;&#x2F;code&gt;, we need to save these registers.
Moreover, since we&#x27;re writing the many parts of a dictionary header, we&#x27;ll load
&lt;code&gt;HERE&lt;&#x2F;code&gt; to &lt;code&gt;DI&lt;&#x2F;code&gt; to streamline things. This is a lot of registers that we need to
push. However, we don&#x27;t actually need to modify any register, so we can just
save &lt;em&gt;all&lt;&#x2F;em&gt; the registers with &lt;code&gt;pusha&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode COLON&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;:&amp;quot;
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pusha
    mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;HERE&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;]
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;MakeLink&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; link field
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;ParseWord
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;cx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosb&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;            ; length field
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;dx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;rep movsb&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;        ; name field

    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0xe8&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;     ; call
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosb
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; The offset is defined as (call target) - (ip after the call instruction)
    ; That works out to DOCOL - (di + 2) = DOCOL - 2 - di
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DOCOL &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;2
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;sub &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosw
    mov &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;HERE&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;], &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;popa
    jmp &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short RBRACK&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; enter compilation mode
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;;&lt;&#x2F;code&gt; is much shorter. We merely need to compile &lt;code&gt;EXIT&lt;&#x2F;code&gt; and go back to
interpretation mode:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode SEMI&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;;&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;F_IMMEDIATE
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;EXIT
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;COMMA
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jmp &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short LBRACK
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The way these words jump to another word at the end is quite convenient.
Remember how the &lt;code&gt;NEXT&lt;&#x2F;code&gt;s are written out as part of the &lt;code&gt;defcode&lt;&#x2F;code&gt; of the next
word? One of the words needs to be last in memory, and then it won&#x27;t have any
&amp;quot;next word&amp;quot; after it. &lt;code&gt;:&lt;&#x2F;code&gt; and &lt;code&gt;;&lt;&#x2F;code&gt; are perfect candidates for this, since they
don&#x27;t need a &lt;code&gt;NEXT&lt;&#x2F;code&gt; at all.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;loading-code-from-disk&quot;&gt;Loading code from disk&lt;&#x2F;h2&gt;
&lt;p&gt;Since we don&#x27;t want to type in disk routines on every boot, we need to include
a way to run source code loaded from disk. A filesystem would be its own beast,
but FORTH tradition has a minimalistic solution: the disk is simply divided
into 1 KiB blocks, in which source code is stored, formatted as 16 lines of 64
characters. Then &lt;code&gt;load ( blknum -- )&lt;&#x2F;code&gt; will execute the block with the specified
number.&lt;&#x2F;p&gt;
&lt;p&gt;We map block 0 into LBA 0 and 1, block 1 into LBA 2 and 3, and so on. This does
mean that block 0 is partially taken by the MBR and LBA 1 is wasted, but I&#x27;m not
particularily bothered by that.&lt;&#x2F;p&gt;
&lt;p&gt;Since the original BIOS service at &lt;code&gt;int 0x13 &#x2F; ah = 0x02&lt;&#x2F;code&gt; requires CHS
addressing, I decided to use the EDD extension variant (&lt;code&gt;ah = 0x42&lt;&#x2F;code&gt;). This does
mean that floppies are not supported, but I wasn&#x27;t planning on using any anyway.&lt;&#x2F;p&gt;
&lt;p&gt;To use the EDD interface, we need to build a &lt;em&gt;disk address packet&lt;&#x2F;em&gt;, which looks
like this:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;db &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x10&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; size of packet
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;db &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; reserved
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;sector_count
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;buffer_offset&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;buffer_segment
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dq &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;LBA
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We use a hybrid strategy to create this packet. The first part is kept as data
in the bootsector, but the rest is written at runtime, even if it doesn&#x27;t
change. The &amp;quot;template&amp;quot; needs to be in a place where we can write after it, so
the perfect place is just before the compressed data:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DiskPacket:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;db &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x10&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.count:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;dw &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;2
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.buffer:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; rest is filled out at runtime, overwriting the compressed data,
    ; which isn&amp;#39;t necessary anymore

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;CompressedData:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;times &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;COMPRESSED_SIZE &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;db &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0xcc
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The first four bytes of the packet are random enough to be hardcoded. However,
when it comes to the address of the buffer, we can do better. We will need to
write said address to &lt;code&gt;InputPtr&lt;&#x2F;code&gt; anyway. The most direct way to do that takes
six bytes:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-lst&quot; data-lang=&quot;lst&quot;&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;c706020a0006    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;word&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;InputPtr&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;], &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;BlockBuf
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;However, we can get that value in &lt;code&gt;AX&lt;&#x2F;code&gt; at no extra cost:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-lst&quot; data-lang=&quot;lst&quot;&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;b80006          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;BlockBuf
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;a3020a          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;InputPtr&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;], &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Thus, we can write these two bytes of the disk packet with only 1 byte of code:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode LOAD&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;load&amp;quot;
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pusha
    mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DiskPacket.buffer
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;BlockBuf
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;word&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;InputPtr&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;], &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosw
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Next, we need to write the segment (&lt;code&gt;0000&lt;&#x2F;code&gt;) and the LBA (which ends in six &lt;code&gt;00&lt;&#x2F;code&gt;
bytes). I like to think of the instructions corresponding to these like so:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;31c0    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xor &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;    ; LBA zeroes
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;ab      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosw&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;         ; segment
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;d1e3    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;shl &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;     ; LBA data
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;93      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xchg &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;   ; LBA data
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;ab      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosw&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;         ; LBA data
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;93      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xchg &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;   ; segment
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;ab      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosw&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;         ; LBA zeroes
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;ab      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosw&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;         ; LBA zeroes
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;ab      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosw&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;         ; LBA zeroes
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;That is, we write the six LBA zeroes in 5 bytes of code. Writing out the segment
only took moving the &lt;code&gt;xor ax, ax&lt;&#x2F;code&gt; earlier, and an additional &lt;code&gt;stosw&lt;&#x2F;code&gt; and &lt;code&gt;xchg ax, bx&lt;&#x2F;code&gt;. Thus, it is neutral at 2 bytes (but we need to write it out in code so
that the pointer is right for the rest of the packet). Lastly, of course, we
have the actual LBA data, which changes.&lt;&#x2F;p&gt;
&lt;p&gt;While &lt;code&gt;AX&lt;&#x2F;code&gt; is zero, let&#x27;s take this opportunity to poke in a null terminator
after the buffer:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;BlockBuf.end&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;], &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now we&#x27;re ready to call the BIOS function. If it errors out, we just loop, as
recovering is complicated — the most annoying complication is that the sector
count in the packet is overwritten by the number of sectors &lt;em&gt;successfully read&lt;&#x2F;em&gt;,
which breaks our template.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DRIVE_NUMBER &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;equ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;+&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;1
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;dl&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ah&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x42
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;DiskPacket
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;int &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;0x13
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jc &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short $
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;popa
    pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h2 id=&quot;printing-numbers&quot;&gt;Printing numbers&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;u.&lt;&#x2F;code&gt; prints an unsigned number, followed by a space. Since splitting the number
into digits with division yields the least-significant digit first, we push the
digits onto the stack, and then pop and print in a separate loop. The space is
printed by pushing a fake &amp;quot;digit&amp;quot; that will get converted into a space. This
also lets us detect when we popped all the digits — the printing loop stops when
it just printed a space.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode UDOT&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;u.&amp;quot;
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xchg &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot; &amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;0&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.split:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xor &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;dx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;dx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;div &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;word&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;BASE&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;]
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;dx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;or &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jnz &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.split
.print:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;add &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;0&amp;quot;
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;cmp &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;9&amp;quot;
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jbe &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.got_digit
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;add &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;A&amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;0&amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ae81ff;&quot;&gt;10
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.got_digit:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;PutChar
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;cmp &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot; &amp;quot;
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jne &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .print
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h2 id=&quot;s-string-poke&quot;&gt;&lt;code&gt;s:&lt;&#x2F;code&gt; — string poke&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;s:&lt;&#x2F;code&gt; is a feature which is, I believe, uniquely relevant to bootstrapping. This
word takes the address of a buffer, and copies the rest of the current input
line there. Without this, a significant amount of code would&#x27;ve had to be typed
in twice: first to actually run it and bootstrap a disk block editor, and then
again to actually save it on disk.&lt;&#x2F;p&gt;
&lt;p&gt;The implementation is just a simple loop, but the setup around it is noteworthy
— we want to load the input pointer into &lt;code&gt;SI&lt;&#x2F;code&gt;, but we also need to preserve &lt;code&gt;SI&lt;&#x2F;code&gt;
so that we can return properly. By using &lt;code&gt;xchg&lt;&#x2F;code&gt;, we can preserve it in
&lt;code&gt;[InputPtr]&lt;&#x2F;code&gt; for the duration of the copy, at no extra cost:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#75715e;&quot;&gt;;; Copies the rest of the line to buf.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode LINE&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;s:&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; ( buf -- buf+len )
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xchg &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;InputPtr&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;.copy:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;lodsb
    mov &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;], &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;inc &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;or &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;jnz &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;short .copy
.done:
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;dec &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;dec &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xchg &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;si&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;InputPtr&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;]
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The destination pointer is kept in &lt;code&gt;BX&lt;&#x2F;code&gt;. While writing at &lt;code&gt;DI&lt;&#x2F;code&gt; would only take a
&lt;code&gt;stosb&lt;&#x2F;code&gt;, getting the pointer in and out of &lt;code&gt;DI&lt;&#x2F;code&gt; outweights this benefit. At the
end, we leave a pointer to the null terminator on the stack. That way, you can
continue the string by just using &lt;code&gt;s:&lt;&#x2F;code&gt; again on the next line. Since we don&#x27;t
skip any leading whitespace, this is even guaranteed to be properly spaced.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;other-primitives&quot;&gt;Other primitives&lt;&#x2F;h2&gt;
&lt;p&gt;Choosing the primitives to include in Miniforth is perhaps the biggest tradeoff
to be made. I am fully expecting that some more primitive words will need to be
defined at runtime by poking in opcodes, but hopefully most of these opcodes
will be generated by a simple FORTH assembler.&lt;&#x2F;p&gt;
&lt;p&gt;Arithmetic as basic as &lt;code&gt;+&lt;&#x2F;code&gt; is indispensible. I am defining both &lt;code&gt;+&lt;&#x2F;code&gt; and &lt;code&gt;-&lt;&#x2F;code&gt;,
though, if I wanted to fit in something more important, I could keep only &lt;code&gt;-&lt;&#x2F;code&gt;
and later define &lt;code&gt;: negate 0 swap - ;&lt;&#x2F;code&gt; and &lt;code&gt;: + negate - ;&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Like any low-level programming language, we need a way to peek and poke values
into memory. The implementation of &lt;code&gt;!&lt;&#x2F;code&gt; is particularily nice, since we can just
pop directly into &lt;code&gt;[bx]&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode PEEK&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;@&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; ( addr -- val )
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, [&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;]

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode POKE&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;!&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; ( val addr -- )
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;word &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;]
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There also are variants that read and write only a single byte:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode CPEEK&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;c@&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; ( addr -- ch )
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;movzx &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#66d9ef;&quot;&gt;byte&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;]

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode CPOKE&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;c!&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; ( ch addr -- )
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;], &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;al
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We certainly need some stack manipulation words. &lt;code&gt;dup&lt;&#x2F;code&gt; and &lt;code&gt;drop&lt;&#x2F;code&gt; have
dead simple implementations, and &lt;code&gt;swap&lt;&#x2F;code&gt; is definitely too useful to skip it.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode DUP&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;dup&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; ( a -- a a )
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode DROP&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;drop&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; ( a -- )
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode SWAP&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;swap&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#75715e;&quot;&gt; ; ( a b -- b a )
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xchg &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I chose to also include &lt;code&gt;&amp;gt;r&lt;&#x2F;code&gt; and &lt;code&gt;r&amp;gt;&lt;&#x2F;code&gt;, which allow using the return stack as
a second stack for values (but, obviously, only within a single word). This is
quite powerful. In fact, combined with &lt;code&gt;dup&lt;&#x2F;code&gt;, &lt;code&gt;drop&lt;&#x2F;code&gt; and &lt;code&gt;swap&lt;&#x2F;code&gt;, they allow you
to implement any stack manipulation word you can imagine.&lt;sup class=&quot;footnote-reference&quot;&gt;&lt;a href=&quot;#stack-complete&quot;&gt;8&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode TO_R&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;&amp;gt;r&amp;quot;
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xchg &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;stosw
    pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx

&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode FROM_R&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;r&amp;gt;&amp;quot;
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;dec &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;dec &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;push &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;mov &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, [&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;di&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;]
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Finally, &lt;code&gt;emit&lt;&#x2F;code&gt; prints a character. This is far enough from the critical path
of the bootstrap, that I would be comfortable with removing this one if need be.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#272822;&quot;&gt;
&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;defcode EMIT&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e6db74;&quot;&gt;&amp;quot;emit&amp;quot;
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;xchg &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f8f8f2;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;ax
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a6e22e;&quot;&gt;PutChar
    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f92672;&quot;&gt;pop &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#fd971f;&quot;&gt;bx
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;&#x2F;h2&gt;
&lt;p&gt;I am pleased with how this turned out. For a system constrained to the boot
sector, I can pretty much call it feature-complete — I can&#x27;t think of anything
that would significantly simplify the bootstrap, while taking few enough bytes
that it seems remotely within the reach of code golf. This is largely thanks to
Ilya Kurdyukov&#x27;s help — without it, I wouldn&#x27;t have been able to fit &lt;code&gt;s:&lt;&#x2F;code&gt; in.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ve found an old PC I can use for my experiments. It boots Miniforth just fine:&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;.&#x2F;hardware.jpg&quot; alt=&quot;&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;I will be documenting my journey of building upon Miniforth in future posts on
this blog. If that sounds like your cup of tea (and it probably does if you&#x27;ve
read this far), consider subscribing to the Atom feed or &lt;a href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;NieDzejkob&quot;&gt;following me on
Twitter&lt;&#x2F;a&gt; to get notified about new posts.&lt;&#x2F;p&gt;
&lt;hr &#x2F;&gt;
&lt;div class=&quot;footnote-definition&quot; id=&quot;ascii-x86&quot;&gt;&lt;sup class=&quot;footnote-definition-label&quot;&gt;1&lt;&#x2F;sup&gt;
&lt;p&gt;And even if that wasn&#x27;t the case, there are &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;EICAR_test_file#Design&quot;&gt;many&lt;&#x2F;a&gt;,
&lt;a href=&quot;http:&#x2F;&#x2F;tom7.org&#x2F;abc&#x2F;&quot;&gt;many&lt;&#x2F;a&gt;
&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;pts&#x2F;pts-xcom&quot;&gt;examples&lt;&#x2F;a&gt; of x86 code written with the printable subset of ASCII.
I&#x27;ve even &lt;a href=&quot;https:&#x2F;&#x2F;codegolf.stackexchange.com&#x2F;questions&#x2F;155018&#x2F;the-programming-language-quiz-mark-ii-cops&#x2F;155023#155023&quot;&gt;done it myself&lt;&#x2F;a&gt; once a few years ago.&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;div class=&quot;footnote-definition&quot; id=&quot;disagree&quot;&gt;&lt;sup class=&quot;footnote-definition-label&quot;&gt;2&lt;&#x2F;sup&gt;
&lt;p&gt;If you, dear reader, find this unsatisfactory, I would like to
invite you on your own journey of bootstrapping. It&#x27;s really quite fun!&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;div class=&quot;footnote-definition&quot; id=&quot;compress-savings&quot;&gt;&lt;sup class=&quot;footnote-definition-label&quot;&gt;3&lt;&#x2F;sup&gt;
&lt;p&gt;The exact savings at the moment are somewhat hard to
calculate, because some words don&#x27;t make use of the &lt;code&gt;NEXT&lt;&#x2F;code&gt; being appended.&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;div class=&quot;footnote-definition&quot; id=&quot;pop-ss&quot;&gt;&lt;sup class=&quot;footnote-definition-label&quot;&gt;4&lt;&#x2F;sup&gt;
&lt;p&gt;While this passage of the reference only talks about &lt;code&gt;pop ss&lt;&#x2F;code&gt;, an
analogous statement is made in the documentation for &lt;code&gt;mov&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;div class=&quot;footnote-definition&quot; id=&quot;pop-esp&quot;&gt;&lt;sup class=&quot;footnote-definition-label&quot;&gt;5&lt;&#x2F;sup&gt;
&lt;p&gt;This seems to be one of the many mistakes in the SDM — using a &lt;code&gt;pop esp&lt;&#x2F;code&gt; for this wouldn&#x27;t work. Section 6.8.3 (&amp;quot;Masking Exceptions and Interrupts
When Switching Stacks&amp;quot;) in Volume 3A clarifies that all single-instruction
ways to load &lt;code&gt;SP&lt;&#x2F;code&gt; work for this. I would&#x27;ve quoted that section instead, if
not for the fact that, while it lists many more types of events that are
suppressed, it actually fails to mention actual interrupts as one of them.
That section does mention some interesting edge-cases, though.  For example,
if you&#x27;re like me, you might be wondering what happens if many instructions in
a row write to &lt;code&gt;SS&lt;&#x2F;code&gt;. The answer is that only the first one is guaranteed to
suppress interrupts.&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;div class=&quot;footnote-definition&quot; id=&quot;imul&quot;&gt;&lt;sup class=&quot;footnote-definition-label&quot;&gt;6&lt;&#x2F;sup&gt;
&lt;p&gt;I suppose it makes sense that this option is only available for &lt;code&gt;imul&lt;&#x2F;code&gt;,
since, by modular arithmetic,  the only difference between a signed and
unsigned multiply is in the upper half of the product, which we are discarding
here. Immediates could be useful with &lt;code&gt;mul&lt;&#x2F;code&gt; too, though...&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;div class=&quot;footnote-definition&quot; id=&quot;base-dw&quot;&gt;&lt;sup class=&quot;footnote-definition-label&quot;&gt;7&lt;&#x2F;sup&gt;
&lt;p&gt;You might ask, why not just declare that &lt;code&gt;BASE&lt;&#x2F;code&gt; is a byte-sized
variable? The answer is that &lt;code&gt;u.&lt;&#x2F;code&gt;, which is the word that prints a number,
uses &lt;code&gt;div word[BASE]&lt;&#x2F;code&gt;, so that the result is still 16-bit.&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;div class=&quot;footnote-definition&quot; id=&quot;stack-complete&quot;&gt;&lt;sup class=&quot;footnote-definition-label&quot;&gt;8&lt;&#x2F;sup&gt;
&lt;p&gt;This does not include words like &lt;code&gt;PICK&lt;&#x2F;code&gt; — you would need
loops for that. Anything definable as &lt;code&gt;( &amp;lt;list of names&amp;gt; -- &amp;lt;list of names&amp;gt; )&lt;&#x2F;code&gt;
is fair game, though. Proving this fact is left as &lt;a href=&quot;https:&#x2F;&#x2F;abstrusegoose.com&#x2F;12&quot;&gt;an exercise to the
reader&lt;&#x2F;a&gt;.&lt;sup class=&quot;footnote-reference&quot;&gt;&lt;a href=&quot;#exercise&quot;&gt;9&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;div class=&quot;footnote-definition&quot; id=&quot;exercise&quot;&gt;&lt;sup class=&quot;footnote-definition-label&quot;&gt;9&lt;&#x2F;sup&gt;
&lt;p&gt;Seriously though, try to devise an infallible strategy for turning
a stack effect into a sequence of words that implement it. It&#x27;s a nice
problem.&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
</content>
	</entry>
</feed>
