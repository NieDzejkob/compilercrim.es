<!DOCTYPE html>
<html lang="en">
    
        
    
    
        
    
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
        <title>How Forth implements exceptions</title>
        <link rel="stylesheet" href="https://niedzejkob.p4.team/style.css?1"/>
        <link rel="icon" href="https://niedzejkob.p4.team/icon.png"/>
        <link rel="canonical" href="https:&#x2F;&#x2F;niedzejkob.p4.team&#x2F;bootstrap&#x2F;throw-catch&#x2F;"/>
        <link rel="alternate" type="application/rss+xml" title="NieDżejkob&#x27;s ramblings" href="/rss.xml">
        
<meta property="og:type" content="article">

        <meta property="og:title" content="How Forth implements exceptions">
        
        <meta property="og:url" content="https:&#x2F;&#x2F;niedzejkob.p4.team&#x2F;bootstrap&#x2F;throw-catch&#x2F;">
        <meta property="og:image" content="https://niedzejkob.p4.team/icon.png">
    </head>
    <body class="theme-default">
        <header>
            <div class="main-column">
                <a href="/">
                    <img id="icon" src="/icon.png">
                    <span><b>NieDżejkob</b>'s ramblings</span>
                </a>
            </div>
        </header>
        <main>
            <article>
                
<h1 class="title">
  How Forth implements exceptions
</h1>

<p class="page-metadata">
August 11, 2021
&middot; 5 minute read
</p>



<div class="series-info">
  This article is part of the <a href="https:&#x2F;&#x2F;niedzejkob.p4.team&#x2F;bootstrap&#x2F;">Bootstrapping</a>
  
    series, in which I start from a 512-byte seed and try to bootstrap a
practical system.
  
  
<div class="previous-next">

<div class="previous-article">
    Previous post:<br>
    <a href="https:&#x2F;&#x2F;niedzejkob.p4.team&#x2F;bootstrap&#x2F;asmless&#x2F;">Branches: No assembly required</a>
</div>



<div class="next-article">
    Next post:<br>
    <a href="https:&#x2F;&#x2F;niedzejkob.p4.team&#x2F;bootstrap&#x2F;exception-context&#x2F;">A better exception model for Forth</a>
</div>


<div style="clear: both;"></div>
</div>

</div>




<section><p>Considering Forth's low-level nature, some might consider it surprising how
well-suited it is to handling exceptions. But ANS Forth specifies a nice and
simple mechanism which can be implemented quite elegantly. Let's take a closer
look.</p>
</section><section id="a-user-s-perspective"><h2>A user's perspective</h2>
<p>The exception mechanism consists of two words: <code>catch</code> and <code>throw</code>.
Unlike other control flow, <code>catch</code> wants an execution token at the top of
the stack. If executing it doesn't throw anything, <code>catch</code> will push a <code>0</code> to
indicate that:</p>
<pre style="background-color:#272822;">
<code class="language-forth" data-lang="forth"><span style="color:#ae81ff;">42 </span><span style="color:#f92672;">&#39; </span><span style="font-style:italic;color:#fd971f;">dup </span><span style="color:#c9d1d9;">catch .s </span><span style="color:#85817e;">( &lt;3&gt; 42 42 0  ok )
</span></code></pre>
<p>On the other hand, if <code>throw</code> is executed, it takes a numeric argument which is
then returned by <code>catch</code>.</p>
<pre style="background-color:#272822;">
<code class="language-forth" data-lang="forth"><span style="color:#f92672;">: </span><span style="color:#a6e22e;">welp </span><span style="color:#ae81ff;">7 </span><span style="color:#c9d1d9;">throw </span><span style="color:#f92672;">;
</span><span style="color:#ae81ff;">1 2 </span><span style="color:#f92672;">&#39; </span><span style="font-style:italic;color:#fd971f;">welp </span><span style="color:#c9d1d9;">catch .s </span><span style="color:#85817e;">( &lt;3&gt; 1 2 7  ok )
</span></code></pre>
<p>One potential issue involves the stack layout at the moment the exception is
thrown. After all, a lot of code could've been executed before we reached a
<code>throw</code>. This is why <code>catch</code> saves the current stack depth before executing the
xt passed as argument — if an exception gets thrown, the stack depth will get
restored:</p>
<pre style="background-color:#272822;">
<code class="language-forth" data-lang="forth"><span style="color:#f92672;">: </span><span style="color:#a6e22e;">welp </span><span style="color:#ae81ff;">3 4 5 7 </span><span style="color:#c9d1d9;">throw </span><span style="color:#f92672;">;
</span><span style="color:#ae81ff;">1 2 </span><span style="color:#f92672;">&#39; </span><span style="font-style:italic;color:#fd971f;">welp </span><span style="color:#c9d1d9;">catch .s </span><span style="color:#85817e;">( &lt;3&gt; 1 2 7  ok )
</span></code></pre>
<p>This does mean that uninitialized stack entries might get created:</p>
<pre style="background-color:#272822;">
<code class="language-forth" data-lang="forth"><span style="color:#f92672;">: </span><span style="color:#a6e22e;">welp </span><span style="color:#66d9ef;">2drop 2drop </span><span style="color:#ae81ff;">7 </span><span style="color:#c9d1d9;">throw </span><span style="color:#f92672;">;
</span><span style="color:#ae81ff;">1 2 3 4 </span><span style="color:#f92672;">&#39; </span><span style="font-style:italic;color:#fd971f;">welp </span><span style="color:#c9d1d9;">catch .s </span><span style="color:#85817e;">( &lt;5&gt; 140620924927952 7 140620924967784 56 7  ok )
</span></code></pre>
<p>Apart from a reserved range, there aren't any rules as
to how this number should be chosen.</p>
<blockquote>
<p>The THROW values <code>{-255...-1}</code> shall be used only as assigned by this standard. The values <code>{-4095...-256}</code> shall be used only as assigned by a system.</p>
<p>Programs shall not define values for use with THROW in the range <code>{-4095...-1}</code>.</p>
</blockquote>
<p>This <em>xt</em> will then be executed, and any exceptions will be caught.
If an exception <em>is</em> caught, the identifying number passed to <code>THROW</code> is left
at the top of the stack. Otherwise, a <code>0</code> is pushed, to signify that nothing was
caught.</p>
<p>Let's take a look at a simple example of how this can be used. First, we'll need
to choose an integer that'll signify our exception's type. ANS Forth doesn't
specify any mechanism for allocating those, so let's just choose a number:</p>
<pre style="background-color:#272822;">
<code class="language-forth" data-lang="forth"><span style="color:#c9d1d9;">-42 </span><span style="color:#f92672;">constant </span><span style="color:#a6e22e;">exn:its-odd
</span></code></pre>
<p>Now, we'll need something that'll throw our exception. For a simple example,
let's say we want a word <code>halve</code>, that will divide a number by two, or throw an
exception if it's odd:</p>
<pre style="background-color:#272822;">
<code class="language-forth" data-lang="forth"><span style="color:#f92672;">: </span><span style="color:#a6e22e;">halve </span><span style="color:#85817e;">( n -- n/2 )
  </span><span style="color:#66d9ef;">dup </span><span style="color:#ae81ff;">1 </span><span style="color:#e6db74;">and </span><span style="color:#f92672;">if
    </span><span style="color:#c9d1d9;">exn:its-odd throw
  </span><span style="color:#f92672;">then </span><span style="color:#c9d1d9;">2/
</span><span style="color:#f92672;">;
</span></code></pre>
<p>Then, let's say <code>print-half</code> wants to use <code>halve</code>, but catch the exception if
the input was wrong:</p>
<pre style="background-color:#272822;">
<code class="language-forth" data-lang="forth"><span style="color:#f92672;">: </span><span style="color:#a6e22e;">print-half </span><span style="color:#85817e;">( n -- )
  </span><span style="color:#f92672;">[&#39;] </span><span style="font-style:italic;color:#fd971f;">halve </span><span style="color:#c9d1d9;">catch </span><span style="color:#f92672;">if
    </span><span style="color:#66d9ef;">drop </span><span style="color:#e6db74;">.&quot; :(&quot;
  </span><span style="color:#f92672;">else
    </span><span style="color:#c9d1d9;">.
  </span><span style="color:#f92672;">then
;
</span></code></pre>
<p>If we test it in, say, Gforth, we'll see that it behaves as we'd expect:</p>
<pre>
<b>42 try-halve</b> 21  ok
<b>1337 try-halve</b> :( ok
</pre>
<p>That's all quite simple, but there's actually a smart aspect of this design.
Namely, if an exception is caught, the stack depth is reset to be the same as
when <code>catch</code> started executing. The stack effect used by the standard explains
this nicely:</p>
<pre style="background-color:#272822;">
<code class="language-forth" data-lang="forth"><span style="color:#c9d1d9;">catch </span><span style="color:#85817e;">( i*x xt -- j*x 0 | i*x n )
</span></code></pre>
<p>Note that to describe the case where a <code>0</code> is pushed (and therefore no exception
occured), a <code>j</code> is used instead of <code>i</code> as the count, to signify that the stack
depth might be different.</p>
<p>This stack adjustment will merely move the stack pointer, so it can either drop
values or create unpredictable ones (though some implementations will choose to
explicitly push zeroes). This means that the only good thing we can do is drop
them.</p>
<p>However, the key is that the number of cells we need to drop is known.
If we called a word that takes 3 arguments, it probably did something to those
stack slots, but <em>nothing beneath them should've been changed</em>. This is why our
implementation of <code>print-half</code> has a <code>drop</code> — we need to discard the <code>n</code> argument
passed to <code>halve</code>.</p>
<pre style="background-color:#272822;">
<code class="language-forth" data-lang="forth"><span style="color:#f92672;">: </span><span style="color:#a6e22e;">print-half </span><span style="color:#85817e;">( n -- )
  </span><span style="color:#c9d1d9;">[&#39;] halve catch if
    <b>drop</b> .&quot; </span><span style="color:#e6db74;">:(</span><span style="color:#c9d1d9;">&quot;
  else
    .
  then
</span><span style="color:#f92672;">;
</span></code></pre>
<p>You might also wonder, what happens if someone tries to throw a <code>0</code>? Wouldn't
that be ambiguous? I suppose it wouldn't be surprising if Forth adopted a &quot;we're
all adults here&quot; stance here, trusting the programmer to not do that. However,
<code>0 throw</code> has been specified to be a no-op. This leads to an idiom for
conditionally throwing exceptions without an explicit <code>if</code>:</p>
<pre style="background-color:#272822;">
<code class="language-forth" data-lang="forth"><span style="color:#f92672;">: </span><span style="color:#a6e22e;">halve </span><span style="color:#85817e;">( n -- n/2 )
  </span><span style="color:#66d9ef;">dup </span><span style="color:#ae81ff;">1 </span><span style="color:#e6db74;">and 0&lt;&gt;  </span><span style="color:#c9d1d9;">exn:its-odd </span><span style="color:#e6db74;">and </span><span style="color:#c9d1d9;">throw
  2/
</span><span style="color:#f92672;">;
</span></code></pre>
<p>This works since, in Forth, the canonical value for <code>true</code> has all the bits set
(unlike C, which only sets the lowest bit), so <code>true exn:its-odd and</code> evaluates
to <code>exn:its-odd</code>.</p>
<hr />
<div class="footnote-definition" id="xt"><sup class="footnote-definition-label">1</sup>
<p>The fun thing about working with a language as old as Forth, is that
terminology has developed that is completely different from what names the
mainstream languages use for equivalent concepts. That is, while <em>execution
token</em> is a perfectly fine name in isolation, everybody else calls it a
<em>function pointer</em>, and it kinda sucks that I have to write footnotes like
these if I want to be understood by the merely Forth-curious, while
simultaneously avoiding odd looks from the Forth veterans. One of these days
I'll simply write a glossary and pepper in a lot of links to it everywhere...</p>
</div>
</section>

<div class="previous-next">

<div class="previous-article">
    Previous post:<br>
    <a href="https:&#x2F;&#x2F;niedzejkob.p4.team&#x2F;bootstrap&#x2F;asmless&#x2F;">Branches: No assembly required</a>
</div>



<div class="next-article">
    Next post:<br>
    <a href="https:&#x2F;&#x2F;niedzejkob.p4.team&#x2F;bootstrap&#x2F;exception-context&#x2F;">A better exception model for Forth</a>
</div>


<div style="clear: both;"></div>
</div>


<noscript>
    This is where the comments would load if you enabled JavaScript.
</noscript>
<script src="https://utteranc.es/client.js"
        repo="NieDzejkob/niedzejkob.p4.team"
        issue-term="pathname"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>
</script>

            </article>
            

<nav>
    <h4>Table of contents</h4>
    <ul>
        
        <li>
            <a href="https:&#x2F;&#x2F;niedzejkob.p4.team&#x2F;bootstrap&#x2F;throw-catch&#x2F;#a-user-s-perspective">A user&#x27;s perspective</a>
            
        </li>
        
    </ul>
</nav>


        </main>
        <footer>
            <div class="main-column">
                <span class="social-links" data-license="CC-BY 4.0 https://fontawesome.com/license">
                    <a href="https://twitter.com/NieDzejkob" target="_blank"><svg width="32" height="32" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" class="svg-inline--fa fa-twitter fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg>
</a>
                    <a href="https://github.com/NieDzejkob" target="_blank"><svg width="32" height="32" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
                    <a href="https://keybase.io/niedzejkob" target="_blank"><svg width="32" height="32" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="keybase" class="svg-inline--fa fa-keybase fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M286.17 419a18 18 0 1 0 18 18 18 18 0 0 0-18-18zm111.92-147.6c-9.5-14.62-39.37-52.45-87.26-73.71q-9.1-4.06-18.38-7.27a78.43 78.43 0 0 0-47.88-104.13c-12.41-4.1-23.33-6-32.41-5.77-.6-2-1.89-11 9.4-35L198.66 32l-5.48 7.56c-8.69 12.06-16.92 23.55-24.34 34.89a51 51 0 0 0-8.29-1.25c-41.53-2.45-39-2.33-41.06-2.33-50.61 0-50.75 52.12-50.75 45.88l-2.36 36.68c-1.61 27 19.75 50.21 47.63 51.85l8.93.54a214 214 0 0 0-46.29 35.54C14 304.66 14 374 14 429.77v33.64l23.32-29.8a148.6 148.6 0 0 0 14.56 37.56c5.78 10.13 14.87 9.45 19.64 7.33 4.21-1.87 10-6.92 3.75-20.11a178.29 178.29 0 0 1-15.76-53.13l46.82-59.83-24.66 74.11c58.23-42.4 157.38-61.76 236.25-38.59 34.2 10.05 67.45.69 84.74-23.84.72-1 1.2-2.16 1.85-3.22a156.09 156.09 0 0 1 2.8 28.43c0 23.3-3.69 52.93-14.88 81.64-2.52 6.46 1.76 14.5 8.6 15.74 7.42 1.57 15.33-3.1 18.37-11.15C429 443 434 414 434 382.32c0-38.58-13-77.46-35.91-110.92zM142.37 128.58l-15.7-.93-1.39 21.79 13.13.78a93 93 0 0 0 .32 19.57l-22.38-1.34a12.28 12.28 0 0 1-11.76-12.79L107 119c1-12.17 13.87-11.27 13.26-11.32l29.11 1.73a144.35 144.35 0 0 0-7 19.17zm148.42 172.18a10.51 10.51 0 0 1-14.35-1.39l-9.68-11.49-34.42 27a8.09 8.09 0 0 1-11.13-1.08l-15.78-18.64a7.38 7.38 0 0 1 1.34-10.34l34.57-27.18-14.14-16.74-17.09 13.45a7.75 7.75 0 0 1-10.59-1s-3.72-4.42-3.8-4.53a7.38 7.38 0 0 1 1.37-10.34L214 225.19s-18.51-22-18.6-22.14a9.56 9.56 0 0 1 1.74-13.42 10.38 10.38 0 0 1 14.3 1.37l81.09 96.32a9.58 9.58 0 0 1-1.74 13.44zM187.44 419a18 18 0 1 0 18 18 18 18 0 0 0-18-18z"></path></svg>
</a>
                </span>
            </div>
        </footer>
    </body>
    <script type="text/javascript" src="/enhance.js" async></script>
    <script data-goatcounter="https://niedzejkob.goatcounter.com/count" async src="https://niedzejkob.p4.team/count.js"></script>
</html>
